<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV AI DEEP SECU ‚Äî Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #0a0e1a;
            color: #e0e4ef;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0d1321 0%, #1a1f36 100%);
            border-bottom: 1px solid #2a3050;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #00d4ff;
            letter-spacing: 1px;
        }
        .header h1 span { color: #ff4757; }
        .header .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #7a8399;
        }
        .status .dot {
            width: 10px; height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0,255,136,0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(0,255,136,0); }
        }

        /* Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 340px;
            grid-template-rows: auto 1fr;
            gap: 16px;
            padding: 16px;
            height: calc(100vh - 60px);
        }

        /* KPI Cards */
        .kpi-row {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
        }
        .kpi-card {
            background: linear-gradient(135deg, #141829 0%, #1c2140 100%);
            border: 1px solid #2a3050;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .kpi-card .icon { font-size: 1.5rem; margin-bottom: 6px; }
        .kpi-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            line-height: 1.1;
        }
        .kpi-card .label {
            font-size: 0.75rem;
            color: #7a8399;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .kpi-card.green .value { color: #00ff88; }
        .kpi-card.red .value { color: #ff4757; }
        .kpi-card.cyan .value { color: #00d4ff; }
        .kpi-card.yellow .value { color: #ffd700; }
        .kpi-card.orange .value { color: #ff8c42; }
        .kpi-card.purple .value { color: #b388ff; }

        /* Video Feed */
        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid #2a3050;
        }
        .video-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .video-label {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0,0,0,0.7);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: #00d4ff;
            border: 1px solid #00d4ff33;
        }

        /* Side Panel */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, #141829 0%, #1c2140 100%);
            border: 1px solid #2a3050;
            border-radius: 12px;
            overflow: hidden;
        }
        .card-header {
            padding: 12px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #00d4ff;
            border-bottom: 1px solid #2a305066;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body { padding: 12px 16px; }

        /* Person List */
        .person-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #1e2540;
        }
        .person-item:last-child { border-bottom: none; }
        .person-info { display: flex; flex-direction: column; gap: 3px; }
        .person-name {
            font-weight: 600;
            color: #fff;
            font-size: 0.9rem;
        }
        .person-meta {
            font-size: 0.75rem;
            color: #7a8399;
        }
        .person-action {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .action-immobile { background: #1a3a2a; color: #00ff88; }
        .action-marcher { background: #1a2a3a; color: #00d4ff; }
        .action-courir { background: #3a2a1a; color: #ff8c42; }
        .action-alert { background: #3a1a1a; color: #ff4757; }

        /* Counter Box */
        .counter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .counter-box {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
        }
        .counter-box.in {
            background: linear-gradient(135deg, #0a2a1a, #1a3a2a);
            border: 1px solid #00ff8833;
        }
        .counter-box.out {
            background: linear-gradient(135deg, #2a0a0a, #3a1a1a);
            border: 1px solid #ff475733;
        }
        .counter-box .c-value {
            font-size: 2rem;
            font-weight: 700;
        }
        .counter-box.in .c-value { color: #00ff88; }
        .counter-box.out .c-value { color: #ff4757; }
        .counter-box .c-label {
            font-size: 0.7rem;
            color: #7a8399;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Events Log */
        .event-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.8rem;
            border-bottom: 1px solid #1e2540;
        }
        .event-item:last-child { border-bottom: none; }
        .event-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        .badge-in { background: #00ff8822; color: #00ff88; }
        .badge-out { background: #ff475722; color: #ff4757; }
        .badge-alert { background: #ffd70022; color: #ffd700; }

        /* Object Tags */
        .obj-tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 0.7rem;
            background: #1a2a3a;
            border: 1px solid #2a4060;
            color: #a0b0c8;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: #2a3050;
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .kpi-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>üõ°Ô∏è CCTV AI <span>DEEP SECU</span></h1>
        <div class="status">
            <div class="dot"></div>
            <span>EN DIRECT</span>
            <span style="margin-left: 12px;" id="clock">--:--:--</span>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard">

        <!-- KPI ROW -->
        <div class="kpi-row">
            <div class="kpi-card cyan">
                <div class="icon">üìä</div>
                <div class="value" id="kpi-fps">--</div>
                <div class="label">FPS</div>
            </div>
            <div class="kpi-card green">
                <div class="icon">üë•</div>
                <div class="value" id="kpi-persons">0</div>
                <div class="label">Personnes</div>
            </div>
            <div class="kpi-card green">
                <div class="icon">üö™</div>
                <div class="value" id="kpi-entries">0</div>
                <div class="label">Entr√©es</div>
            </div>
            <div class="kpi-card red">
                <div class="icon">üö∂</div>
                <div class="value" id="kpi-exits">0</div>
                <div class="label">Sorties</div>
            </div>
            <div class="kpi-card yellow">
                <div class="icon">üìç</div>
                <div class="value" id="kpi-present">0</div>
                <div class="label">Pr√©sents</div>
            </div>
            <div class="kpi-card orange">
                <div class="icon">üö®</div>
                <div class="value" id="kpi-alerts">0</div>
                <div class="label">Alertes</div>
            </div>
        </div>

        <!-- VIDEO FEED -->
        <div class="video-container">
            <div class="video-label">üî¥ LIVE ‚Äî MJPEG</div>
            <img id="video-feed" src="/video_feed" alt="Flux vid√©o en direct">
        </div>

        <!-- SIDE PANEL -->
        <div class="side-panel">

            <!-- Counter -->
            <div class="card">
                <div class="card-header">üö™ Compteur</div>
                <div class="card-body">
                    <div class="counter-grid">
                        <div class="counter-box in">
                            <div class="c-value" id="counter-in">0</div>
                            <div class="c-label">Entr√©es</div>
                        </div>
                        <div class="counter-box out">
                            <div class="c-value" id="counter-out">0</div>
                            <div class="c-label">Sorties</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Persons -->
            <div class="card" style="flex: 1; overflow: hidden;">
                <div class="card-header">üë§ Personnes d√©tect√©es</div>
                <div class="card-body" id="persons-list" style="overflow-y: auto; max-height: 300px;">
                    <div style="color: #555; text-align: center; padding: 20px;">
                        En attente de d√©tections...
                    </div>
                </div>
            </div>

            <!-- Events -->
            <div class="card">
                <div class="card-header">üìã √âv√©nements r√©cents</div>
                <div class="card-body" id="events-list" style="max-height: 180px; overflow-y: auto;">
                    <div style="color: #555; text-align: center; padding: 12px;">
                        Aucun √©v√©nement
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // === Auto-refresh toutes les secondes ===
        function updateDashboard() {
            // Stats syst√®me
            fetch('/api/stats')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('kpi-fps').textContent =
                        data.fps ? data.fps.toFixed(1) : '--';
                    document.getElementById('kpi-persons').textContent =
                        data.detections || 0;

                    if (data.counter) {
                        document.getElementById('kpi-entries').textContent =
                            data.counter.total_entries || 0;
                        document.getElementById('kpi-exits').textContent =
                            data.counter.total_exits || 0;
                        document.getElementById('kpi-present').textContent =
                            data.counter.present || 0;
                        document.getElementById('counter-in').textContent =
                            data.counter.total_entries || 0;
                        document.getElementById('counter-out').textContent =
                            data.counter.total_exits || 0;
                    }
                })
                .catch(e => {});

            // Alertes
            fetch('/api/alerts')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('kpi-alerts').textContent =
                        data.total_alerts || 0;
                })
                .catch(e => {});

            // Personnes
            fetch('/api/persons')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('persons-list');
                    const keys = Object.keys(data);

                    if (keys.length === 0) {
                        container.innerHTML = '<div style="color: #555; text-align: center; padding: 20px;">En attente...</div>';
                        return;
                    }

                    let html = '';
                    keys.forEach(tid => {
                        const p = data[tid];
                        const action = p.current_action || 'N/A';
                        const isAlert = ['chute', 'donner_un_coup', 'mains_en_l_air'].includes(action);
                        const isMoving = ['marcher', 'courir'].includes(action);
                        const actionClass = isAlert ? 'action-alert' :
                                           isMoving ? 'action-marcher' :
                                           action === 'immobile' ? 'action-immobile' : '';

                        // Dur√©e format√©e
                        const secs = p.presence_time || 0;
                        const mins = Math.floor(secs / 60);
                        const s = Math.floor(secs % 60);
                        const duration = mins > 0 ? `${mins}m ${s}s` : `${s}s`;

                        // Objects
                        let objHtml = '';
                        if (p.objects && p.objects.length > 0) {
                            objHtml = p.objects.map(o =>
                                `<span class="obj-tag">${o}</span>`
                            ).join('');
                        }

                        html += `
                        <div class="person-item">
                            <div class="person-info">
                                <div class="person-name">${p.name || 'INCONNU'} <span style="color:#555">#${tid}</span></div>
                                <div class="person-meta">‚è± ${duration}${objHtml ? ' | ' + objHtml : ''}</div>
                            </div>
                            <div class="person-action ${actionClass}">${action}</div>
                        </div>`;
                    });

                    container.innerHTML = html;
                })
                .catch(e => {});

            // Events (compteur)
            fetch('/api/counter')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('events-list');
                    const events = data.recent_events || [];

                    if (events.length === 0) {
                        container.innerHTML = '<div style="color: #555; text-align: center; padding: 12px;">Aucun</div>';
                        return;
                    }

                    let html = '';
                    events.slice(-10).reverse().forEach(ev => {
                        const badgeClass = ev.type === 'ENTREE' ? 'badge-in' : 'badge-out';
                        const t = new Date(ev.time * 1000);
                        const timeStr = t.toLocaleTimeString('fr-FR');

                        html += `
                        <div class="event-item">
                            <span class="event-badge ${badgeClass}">${ev.type}</span>
                            <span>${ev.name || 'ID:' + ev.track_id}</span>
                            <span style="margin-left:auto; color:#555">${timeStr}</span>
                        </div>`;
                    });

                    container.innerHTML = html;
                })
                .catch(e => {});
        }

        // Horloge
        function updateClock() {
            document.getElementById('clock').textContent =
                new Date().toLocaleTimeString('fr-FR');
        }

        // D√©marrer
        setInterval(updateDashboard, 1000);
        setInterval(updateClock, 1000);
        updateDashboard();
        updateClock();
    </script>
</body>
</html>
